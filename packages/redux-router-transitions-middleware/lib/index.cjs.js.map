{"version":3,"file":"index.cjs.js","sources":["../src/index.js"],"sourcesContent":["import { ROUTER_DID_CHANGE } from '@sigfox/redux-router/lib/constants';\n\nconst locationsAreEqual = (locA, locB) =>\n  locA.pathname === locB.pathname && locA.search === locB.search;\n\nconst getDataDependency = (component = {}, methodName) =>\n  // eslint-disable-line arrow-body-style\n  (component.WrappedComponent ?\n    getDataDependency(component.WrappedComponent, methodName)\n    : component[methodName]);\n\nconst getDataDependencies = (components, getState, dispatch, location, params, deferred) => {\n  const methodName = deferred ? 'fetchDataDeferred' : 'fetchData';\n\n  let previousPromise = Promise.resolve();\n  return (\n    components\n      // only look at ones with a static fetchData()\n      .filter(component => getDataDependency(component, methodName))\n      // pull out fetch data methods\n      .map(component => getDataDependency(component, methodName))\n      // call fetch data methods and save promises\n      .map((fetchData) => {\n        const promise = fetchData({ getState, dispatch, location, params, previousPromise });\n        previousPromise = promise;\n        return promise;\n      })\n  );\n};\n\nconst routerTransitionsMiddleware = ({ getState, dispatch }) => next => (action) => {\n  if (action.type === ROUTER_DID_CHANGE) {\n    if (\n      getState().router\n      && locationsAreEqual(action.payload.location, getState().router.location)\n    ) {\n      // if you remove this (because you want to force reloading) you break reconciliation\n      // between server-rendered markup and client first render\n      // (everything gets re-fetched and re-rendered)\n      return next(action);\n    }\n\n    const { components, location, params } = action.payload;\n    const promise = new Promise((resolve) => {\n      const doTransition = () => {\n        const promises = getDataDependencies(\n          components,\n          getState,\n          dispatch,\n          location,\n          params,\n          true\n        );\n        // Calling the fetchDataDeferred first allow the REQUEST type (\"api\")\n        // action to be dispatched before the page component is mounted\n        next(action);\n        Promise.all(promises).then(resolve, resolve);\n      };\n\n      Promise.all(getDataDependencies(components, getState, dispatch, location, params)).then(\n        doTransition,\n        doTransition\n      );\n    });\n\n    // eslint-disable-next-line no-undef\n    if (__SERVER__) {\n      // router state is null until ReduxRouter is created so we can use this to store\n      // our promise to let the server know when it can render\n      // eslint-disable-next-line no-param-reassign\n      getState().router = promise;\n    }\n\n    return promise;\n  }\n\n  return next(action);\n};\n\nexport default routerTransitionsMiddleware;\n"],"names":["locationsAreEqual","locA","locB","pathname","search","getDataDependency","component","methodName","WrappedComponent","getDataDependencies","components","getState","dispatch","location","params","deferred","previousPromise","Promise","resolve","filter","map","fetchData","promise","routerTransitionsMiddleware","next","action","type","ROUTER_DID_CHANGE","router","payload","doTransition","promises","all","then","__SERVER__"],"mappings":";;;;;;AAEA,IAAMA,iBAAiB,GAAG,SAApBA,iBAAoB,CAACC,IAAD,EAAOC,IAAP;SACxBD,IAAI,CAACE,QAAL,KAAkBD,IAAI,CAACC,QAAvB,IAAmCF,IAAI,CAACG,MAAL,KAAgBF,IAAI,CAACE,MADhC;CAA1B;;AAGA,IAAMC,iBAAiB,GAAG,SAApBA,iBAAoB;MAACC,SAAD,uEAAa,EAAb;MAAiBC,UAAjB;;IAEvBD,SAAS,CAACE,gBAAV,GACCH,iBAAiB,CAACC,SAAS,CAACE,gBAAX,EAA6BD,UAA7B,CADlB,GAEGD,SAAS,CAACC,UAAD;;CAJf;;AAMA,IAAME,mBAAmB,GAAG,SAAtBA,mBAAsB,CAACC,UAAD,EAAaC,QAAb,EAAuBC,QAAvB,EAAiCC,QAAjC,EAA2CC,MAA3C,EAAmDC,QAAnD,EAAgE;MACpFR,UAAU,GAAGQ,QAAQ,GAAG,mBAAH,GAAyB,WAApD;MAEIC,eAAe,GAAGC,OAAO,CAACC,OAAR,EAAtB;SAEER,UAAU;GAEPS,MAFH,CAEU,UAAAb,SAAS;WAAID,iBAAiB,CAACC,SAAD,EAAYC,UAAZ,CAArB;GAFnB;GAIGa,GAJH,CAIO,UAAAd,SAAS;WAAID,iBAAiB,CAACC,SAAD,EAAYC,UAAZ,CAArB;GAJhB;GAMGa,GANH,CAMO,UAACC,SAAD,EAAe;QACZC,OAAO,GAAGD,SAAS,CAAC;MAAEV,QAAQ,EAARA,QAAF;MAAYC,QAAQ,EAARA,QAAZ;MAAsBC,QAAQ,EAARA,QAAtB;MAAgCC,MAAM,EAANA,MAAhC;MAAwCE,eAAe,EAAfA;KAAzC,CAAzB;IACAA,eAAe,GAAGM,OAAlB;WACOA,OAAP;GATJ,CADF;CAJF;;AAmBA,IAAMC,2BAA2B,GAAG,SAA9BA,2BAA8B;MAAGZ,QAAH,QAAGA,QAAH;MAAaC,QAAb,QAAaA,QAAb;SAA4B,UAAAY,IAAI;WAAI,UAACC,MAAD,EAAY;UAC9EA,MAAM,CAACC,IAAP,KAAgBC,2BAApB,EAAuC;YAEnChB,QAAQ,GAAGiB,MAAX,IACG5B,iBAAiB,CAACyB,MAAM,CAACI,OAAP,CAAehB,QAAhB,EAA0BF,QAAQ,GAAGiB,MAAX,CAAkBf,QAA5C,CAFtB,EAGE;;;;iBAIOW,IAAI,CAACC,MAAD,CAAX;;;8BAGuCA,MAAM,CAACI,OAXX;YAW7BnB,UAX6B,mBAW7BA,UAX6B;YAWjBG,QAXiB,mBAWjBA,QAXiB;YAWPC,MAXO,mBAWPA,MAXO;YAY/BQ,OAAO,GAAG,IAAIL,OAAJ,CAAY,UAACC,OAAD,EAAa;cACjCY,YAAY,GAAG,SAAfA,YAAe,GAAM;gBACnBC,QAAQ,GAAGtB,mBAAmB,CAClCC,UADkC,EAElCC,QAFkC,EAGlCC,QAHkC,EAIlCC,QAJkC,EAKlCC,MALkC,EAMlC,IANkC,CAApC,CADyB;;;YAWzBU,IAAI,CAACC,MAAD,CAAJ;YACAR,OAAO,CAACe,GAAR,CAAYD,QAAZ,EAAsBE,IAAtB,CAA2Bf,OAA3B,EAAoCA,OAApC;WAZF;;UAeAD,OAAO,CAACe,GAAR,CAAYvB,mBAAmB,CAACC,UAAD,EAAaC,QAAb,EAAuBC,QAAvB,EAAiCC,QAAjC,EAA2CC,MAA3C,CAA/B,EAAmFmB,IAAnF,CACEH,YADF,EAEEA,YAFF;SAhBc,CAAhB,CAZqC;;YAmCjCI,UAAJ,EAAgB;;;;UAIdvB,QAAQ,GAAGiB,MAAX,GAAoBN,OAApB;;;eAGKA,OAAP;;;aAGKE,IAAI,CAACC,MAAD,CAAX;KA9CkE;GAAhC;CAApC;;;;"}